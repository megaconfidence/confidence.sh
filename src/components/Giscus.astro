---
// Giscus comments component
// https://giscus.app
---

<div class="giscus-wrapper">
	<script
		src="https://giscus.app/client.js"
		data-repo="megaconfidence/confidence.sh"
		data-repo-id="R_kgDOIy6h6w"
		data-category="Announcements"
		data-category-id="DIC_kwDOIy6h684CTu78"
		data-mapping="pathname"
		data-strict="0"
		data-reactions-enabled="1"
		data-emit-metadata="0"
		data-input-position="bottom"
		data-theme="light"
		data-lang="en"
		crossorigin="anonymous"
		async
	></script>
</div>

<script>
	let giscusObserver: MutationObserver | null = null;

	document.addEventListener('astro:page-load', () => {
		// Clean up previous observer
		giscusObserver?.disconnect();
		giscusObserver = null;

		const wrapper = document.querySelector('.giscus-wrapper');
		if (!wrapper) return;

		function updateGiscusTheme() {
			const isDark = document.documentElement.classList.contains('dark');
			const theme = isDark ? 'transparent_dark' : 'light';
			const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
			if (iframe) {
				iframe.contentWindow?.postMessage(
					{ giscus: { setConfig: { theme } } },
					'https://giscus.app',
				);
			}
		}

		// Set initial theme once Giscus loads
		giscusObserver = new MutationObserver((mutations) => {
			for (const mutation of mutations) {
				for (const node of mutation.addedNodes) {
					if (node instanceof HTMLIFrameElement && node.classList.contains('giscus-frame')) {
						node.addEventListener('load', () => updateGiscusTheme());
						giscusObserver?.disconnect();
					}
				}
			}
		});
		giscusObserver.observe(wrapper, {
			childList: true,
			subtree: true,
		});

		// Listen for theme toggle changes
		const themeToggle = document.querySelector('.theme-toggle');
		if (themeToggle) {
			themeToggle.addEventListener('click', () => {
				setTimeout(updateGiscusTheme, 50);
			});
		}
	});
</script>

<style>
	.giscus-wrapper {
		margin-top: 3em;
		padding-top: 2em;
		border-top: 1px solid var(--border);
	}
</style>
